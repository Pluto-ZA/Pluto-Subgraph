specVersion: v0.1.0
package:
  name: jupiter-dex-substreams
  version: v0.3.1
  image: assets/icon.png

binaries:
  default:
    type: wasm/rust-v1
    file: ./target/wasm32-unknown-unknown/release/jupiter_dex_substreams.wasm

protobuf:
  files:
    - jupiter/events/v1/events.proto
    - proto/sf/jupiter/v1/types.proto
  importPaths:
    - jupiter
    - proto

network: solana

modules:
  # --- PIPELINE 1: GLOBAL PRICING (No filters) ---

  - name: map_global_token_prices
    kind: map
    initialBlock: 31310775
    inputs:
      - source: sf.solana.type.v1.Block
    output:
      type: proto:sf.jupiter.v1.TokenPriceList

  - name: store_token_prices
    kind: store
    initialBlock: 31310775
    updatePolicy: set
    valueType: float64
    inputs:
      - map: map_global_token_prices


  # --- PIPELINE 2: FILTERED USER TRACKING ---

  # 1. STORE: Balances
  - name: store_portfolio_balances
    kind: store
    initialBlock: 31310775
    updatePolicy: add
    valueType: float64
    inputs:
      - map: map_relevant_transactions # Uses the output from your tx parser

  - name: store_trading_volume
    kind: store
    initialBlock: 31310775
    updatePolicy: add
    valueType: float64
    inputs:
      - map: map_jupiter_trading_data
      - store: store_token_prices


  # 3. MAP: Final Aggregates (Output Deltas)
  - name: map_stats_updates
    kind: map
    initialBlock: 31310775
    inputs:
      - store: store_portfolio_balances
        mode: deltas
      - store: store_trading_volume
        mode: deltas
      - store: store_token_prices
    output:
      type: proto:sf.jupiter.v1.WalletAggregatesList

  # standard transactions
  - name: map_relevant_transactions
    kind: map
    initialBlock: 31310775
    inputs:
      - params: string
      - source: sf.solana.type.v1.Block
    output:
      type: proto:sf.jupiter.v1.TransactionHistory

  - name: map_spl_initialized_account
    kind: map
    initialBlock: 31310775
    inputs:
      - source: sf.solana.type.v1.Block
    output:
      type: proto:sf.jupiter.v1.AccountOwnerRecords

  - name: map_jupiter_trading_data
    kind: map
    initialBlock: 31310775
    inputs:
      - params: string
      - source: sf.solana.type.v1.Block
    output:
      type: proto:sf.jupiter.v1.TradingDataList

  - name: map_jupiter_instructions
    kind: map
    initialBlock: 31310775
    inputs:
      - params: string
      - source: sf.solana.type.v1.Block
      - map: map_spl_initialized_account
      - map: map_jupiter_trading_data
      - map: map_global_token_prices
    output:
      type: proto:sf.jupiter.v1.JupiterInstructions

#  - name: map_jupiter_analytics
#    kind: map
#    initialBlock: 31310775
#    inputs:
#      - map: map_jupiter_instructions
#    output:
#      type: proto:sf.jupiter.v1.JupiterAnalytics